package com.example.gps.activities;

import android.Manifest;
import android.app.Activity;
import android.content.Context;
import android.content.Intent;
import android.content.SharedPreferences;
import android.content.pm.PackageManager;
import android.content.res.ColorStateList;
import android.location.Location;
import android.os.Bundle;
import android.os.Handler;
import android.os.Looper;
import android.util.Log;
import android.view.View;
import android.view.inputmethod.EditorInfo;
import android.view.inputmethod.InputMethodManager;
import android.widget.EditText;
import android.widget.ImageView;
import android.widget.PopupMenu;
import android.widget.TextView;
import android.widget.Toast;
import java.util.Iterator;

import androidx.annotation.NonNull;
import androidx.appcompat.app.AppCompatActivity;
import androidx.core.app.ActivityCompat;
import androidx.core.content.ContextCompat;
import androidx.drawerlayout.widget.DrawerLayout;
import androidx.recyclerview.widget.LinearLayoutManager;
import androidx.recyclerview.widget.RecyclerView;

import com.example.gps.R;
import com.example.gps.activities.Friend.FriendsActivity;
import com.example.gps.activities.Register_Login.LoginActivity;
import com.example.gps.adapters.SearchResultAdapter;
import com.example.gps.api.ApiClient; // Still needed for other API calls if any
import com.example.gps.dto.LocationResponse;
import com.example.gps.fragments.SearchResultDetailFragment;
import com.example.gps.fragments.WeatherBottomSheetFragment;
import com.example.gps.model.SearchResult;
import com.example.gps.utils.TokenManager;
import com.google.android.material.floatingactionbutton.FloatingActionButton;
import com.google.firebase.database.DataSnapshot;
import com.google.firebase.database.DatabaseError;
import com.google.firebase.database.DatabaseReference;
import com.google.firebase.database.FirebaseDatabase;
import com.google.firebase.database.ValueEventListener;
import com.naver.maps.geometry.LatLng;
import com.naver.maps.map.CameraAnimation;
import com.naver.maps.map.CameraUpdate;
import com.naver.maps.map.LocationTrackingMode;
import com.naver.maps.map.MapView;
import com.naver.maps.map.NaverMap;
import com.naver.maps.map.OnMapReadyCallback;
import com.naver.maps.map.overlay.Marker;
import com.naver.maps.map.util.FusedLocationSource;

import org.json.JSONArray;
import org.json.JSONObject;

import java.io.BufferedReader;
import java.io.InputStreamReader;
import java.net.HttpURLConnection;
import java.net.URL;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Locale;
import java.util.Map;
import java.util.concurrent.ExecutorService;
import java.util.concurrent.Executors;

import com.example.gps.api.GroupApiService; // ‚≠êÔ∏è Ï∂îÍ∞Ä: Í∑∏Î£π API
import com.example.gps.api.UserApiService;

import retrofit2.Call;
import retrofit2.Callback;
import retrofit2.Response;

public class MapsActivity extends AppCompatActivity implements OnMapReadyCallback, SearchResultDetailFragment.OnDestinationSelectedListener {

    // --- UI & Map Variables ---
    private MapView mapView;
    private NaverMap naverMap;
    private FusedLocationSource locationSource;
    private DrawerLayout drawerLayout;

    // --- Search UI & Data ---
    private EditText etSearch;
    private ImageView ivSearchIcon;
    private RecyclerView rvSearchResults;
    private SearchResultAdapter searchResultAdapter;
    private Marker searchResultMarker = null;

    // --- Weather UI ---
    private ImageView ivWeatherIcon;
    private TextView tvTemperature;

    // --- Menu UI & State ---
    private boolean isSubMenuOpen = false;
    private static final float SUB_MENU_RADIUS_DP = 80f;

    // --- Background Tasks ---
    private final ExecutorService executor = Executors.newSingleThreadExecutor();
    private final Handler handler = new Handler(Looper.getMainLooper());

    // --- Constants ---
    private static final int LOCATION_PERMISSION_REQUEST_CODE = 1000;
    private static final String OPENWEATHERMAP_API_KEY = "7a4aa78797771aa887fe9b14a9be94e5";
    private static final String NAVER_CLIENT_ID = "OAQnuwhbAL34Of8mlxve";
    private static final String NAVER_CLIENT_SECRET = "4roXQDJBpc";
    private static final int LOCATION_UPDATE_INTERVAL = 10000; // 10 seconds
    private static final String TAG = "MapsActivity_FIREBASE"; // üéØ Firebase Î°úÍ∑∏ TAG Ï∂îÍ∞Ä

    // --- User & State ---
    private String loggedInUsername;
    private boolean isSelectionMode = false;

    // --- Firebase & Real-time Location Sharing ---
    private Long currentGroupId = -1L;
    private DatabaseReference firebaseDatabase;
    private ValueEventListener memberLocationListener;
    private final Handler locationUpdateHandler = new Handler(Looper.getMainLooper());
    private Runnable locationUpdateRunnable;
    private final HashMap<String, Marker> memberMarkers = new HashMap<>();

    private final Map<Long, Boolean> incomingSharingRules = new HashMap<>();
    private Marker myLocationMarker = null;

    // --- Mock Movement (for testing) ---
    private Handler animationHandler;
    private Runnable animationRunnable;
    private LatLng startLatLng = new LatLng(37.5665, 126.9780); // Seoul City Hall
    private LatLng endLatLng = new LatLng(35.115, 129.04); // Busan Station
    private final long totalDuration = 10000; // 10 seconds
    private final int updateInterval = 50; // 50ms
    private long startTime;

    private Long loggedInUserId = -1L;

    private boolean rulesNeedReload = false;

    private DatabaseReference rulesVersionRef;
    private ValueEventListener rulesVersionListener;

    private List<LocationResponse> currentMemberLocations = new ArrayList<>();

    //==============================================================================================
    // 1. Activity Lifecycle & Setup
    //==============================================================================================

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_maps);

        checkLocationPermission();
        handleIntent(getIntent());

        // --- Initialize Components ---
        mapView = findViewById(R.id.map_view);
        mapView.onCreate(savedInstanceState);
        ivWeatherIcon = findViewById(R.id.iv_weather_icon);
        tvTemperature = findViewById(R.id.tv_temperature);
        drawerLayout = findViewById(R.id.drawer_layout);

        loggedInUsername = getIntent().getStringExtra("username");

        // üéØ Î°úÍ∑∏ Ï∂îÍ∞Ä: Ïï± ÏãúÏûë Ïãú Firebase Ï¥àÍ∏∞Ìôî Î∞è ÏÇ¨Ïö©ÏûêÎ™Ö ÌôïÏù∏
        Log.d(TAG, "onCreate: FirebaseDatabase Ïù∏Ïä§ÌÑ¥Ïä§ ÌöçÎìù ÏãúÎèÑ");
        firebaseDatabase = FirebaseDatabase.getInstance().getReference("group_locations");
        Log.d(TAG, "onCreate: ÏÇ¨Ïö©ÏûêÎ™Ö ÌôïÏù∏ (loggedInUsername)=" + loggedInUsername);

        initializeMap();
        initializeButtons();
        initializeSearch();
        initializeSubMenu();
        bindMyPageHeader();

        if (loggedInUsername != null) {
            fetchLoggedInUserId();
        }
    }

    @Override
    public void onMapReady(@NonNull NaverMap map) {
        this.naverMap = map;
        naverMap.setLocationSource(locationSource);
        naverMap.setLocationTrackingMode(LocationTrackingMode.Follow);

        LatLng initialPosition = new LatLng(37.5665, 126.9780); // ÏÑúÏö∏ ÏãúÏ≤≠ Ï¢åÌëú
        naverMap.moveCamera(CameraUpdate.scrollAndZoomTo(initialPosition, 11));

        if (myLocationMarker == null) {
            myLocationMarker = new Marker();
            myLocationMarker.setCaptionText("ÎÇ¥ ÏúÑÏπò");
        }
        myLocationMarker.setPosition(initialPosition);
        myLocationMarker.setMap(naverMap);

        // üéØ Î°úÍ∑∏ Ï∂îÍ∞Ä: ÏúÑÏπò Î≥ÄÍ≤Ω Î¶¨Ïä§ÎÑà Îì±Î°ù ÌôïÏù∏
        Log.d(TAG, "onMapReady: NaverMap ÏúÑÏπò Î≥ÄÍ≤Ω Î¶¨Ïä§ÎÑà Îì±Î°ù ÏôÑÎ£å");

        naverMap.addOnLocationChangeListener(location -> {
            if (location != null && Double.isFinite(location.getLatitude()) && Double.isFinite(location.getLongitude())) {
                LatLng currentLocation = new LatLng(location.getLatitude(), location.getLongitude());
                if (animationHandler == null) {
                    myLocationMarker.setPosition(currentLocation);
                }
                updateWeatherWidget(currentLocation);
            }
        });

        applyMapTypeSetting();
        loadWeatherData();
    }

    //==============================================================================================
    // 2. Initializers
    //==============================================================================================

    private void initializeMap() {
        locationSource = new FusedLocationSource(this, LOCATION_PERMISSION_REQUEST_CODE);
        mapView.getMapAsync(this);
    }

    private void initializeButtons() {

        FloatingActionButton btnMapType = findViewById(R.id.btnMapType);
        FloatingActionButton btnMyLocation = findViewById(R.id.btnMyLocation);
        FloatingActionButton btnTestMovement = findViewById(R.id.btnTestMovement);
        findViewById(R.id.weather_widget).setOnClickListener(v -> showWeatherBottomSheet());

        FloatingActionButton btnMainMenu = findViewById(R.id.btnMainMenu);
        FloatingActionButton btnFriends = findViewById(R.id.btnFriends);
        FloatingActionButton btnCreateGroup = findViewById(R.id.btnCreateGroup);
        FloatingActionButton btnMyGroups = findViewById(R.id.btnMyGroups);
        FloatingActionButton btnMyPage = findViewById(R.id.btnMyPage);
        FloatingActionButton btnSettings = findViewById(R.id.btnSettings);

        btnMapType.setOnClickListener(this::showMapTypeMenu);
        btnMyLocation.setOnClickListener(v -> moveToCurrentLocation());
        if (btnTestMovement != null) {
            btnTestMovement.setOnClickListener(v -> startMockMovement());
        }

        btnMainMenu.setOnClickListener(v -> toggleSubMenu());

        // ‚≠ê [ÏàòÏ†ï] FriendsActivityÎ°ú username Ï†ÑÎã¨
        btnFriends.setOnClickListener(v -> {
            startActivity(new Intent(this, FriendsActivity.class).putExtra("username", loggedInUsername));
            hideSubMenu();
        });

        // ‚≠ê [ÏàòÏ†ï] CreateGroupActivityÎ°ú username Ï†ÑÎã¨
        btnCreateGroup.setOnClickListener(v -> {
            startActivity(new Intent(this, CreateGroupActivity.class).putExtra("username", loggedInUsername));
            hideSubMenu();
        });

        // ‚≠ê [ÌïµÏã¨ ÏàòÏ†ï] MyGroupsActivityÎ°ú username Ï†ÑÎã¨
        btnMyGroups.setOnClickListener(v -> {
            Intent intent = new Intent(this, MyGroupsActivity.class);
            intent.putExtra("username", loggedInUsername);
            startActivity(intent);
            hideSubMenu();
        });

        btnMyPage.setOnClickListener(v -> {
            View sidebar = findViewById(R.id.sidebar);
            if (drawerLayout.isDrawerOpen(sidebar)) {
                drawerLayout.closeDrawer(sidebar);
            } else {
                drawerLayout.openDrawer(sidebar);
            }
            hideSubMenu();
        });

        btnSettings.setOnClickListener(v -> {
            startActivity(new Intent(this, SettingsActivity.class));
            hideSubMenu();
        });
    }

    private void initializeSearch() {
        // ... (Í≤ÄÏÉâ UI Ï¥àÍ∏∞Ìôî Î°úÏßÅÏùÄ ÎèôÏùº)
        etSearch = findViewById(R.id.et_search);
        ivSearchIcon = findViewById(R.id.iv_search_icon);
        rvSearchResults = findViewById(R.id.rv_search_results);

        searchResultAdapter = new SearchResultAdapter();
        rvSearchResults.setLayoutManager(new LinearLayoutManager(this));
        rvSearchResults.setAdapter(searchResultAdapter);

        ivSearchIcon.setOnClickListener(v -> performSearch());

        searchResultAdapter.setOnItemClickListener(searchResult -> {
            if (isSelectionMode) {
                Intent resultIntent = new Intent();
                resultIntent.putExtra("PLACE_NAME", searchResult.getTitle());
                resultIntent.putExtra("PLACE_LAT", searchResult.getLatitude());
                resultIntent.putExtra("PLACE_LNG", searchResult.getLongitude());
                setResult(Activity.RESULT_OK, resultIntent);
                finish();
            } else {
                moveToSearchResult(searchResult);
                hideSearchResults();
            }
        });

        etSearch.setOnEditorActionListener((v, actionId, event) -> {
            if (actionId == EditorInfo.IME_ACTION_SEARCH) {
                performSearch();
                return true;
            }
            return false;
        });
    }

    //==============================================================================================
    // 3. Real-time Location Sharing (Firebase - Î°úÍ∑∏ Ï∂îÍ∞Ä)
    //==============================================================================================

    @Override
    protected void onNewIntent(Intent intent) {
        super.onNewIntent(intent);
        // ‚≠ê [Ï∂îÍ∞Ä] onNewIntentÏóêÏÑú handleIntentÎ•º Ìò∏Ï∂úÌïòÍ∏∞ Ï†ÑÏóê setIntent(intent)Î•º Ï∂îÍ∞ÄÌïòÏó¨,
        //      Ïï°Ìã∞ÎπÑÌã∞Í∞Ä ÌòÑÏû¨ IntentÎ•º ÏÉà IntentÎ°ú Í∞±Ïã†ÌïòÎèÑÎ°ù Í∞ïÏ†úÌï©ÎãàÎã§.

        if (intent != null && intent.getBooleanExtra("RULES_UPDATED", false)) {
            rulesNeedReload = true;
            Log.d(TAG, "onNewIntent: Í≥µÏú† ÏÑ§Ï†ï Î≥ÄÍ≤Ω Í∞êÏßÄ. Í∑úÏπô Ïû¨Î°úÎìú ÌîåÎûòÍ∑∏ ÏÑ§Ï†ï.");
        }

        setIntent(intent);
        handleIntent(intent);
    }

    private void handleIntent(Intent intent) {
        if (intent == null) return;

        // üí° [Ï∂îÍ∞Ä] CreateGroupActivityÏóêÏÑú ÎèåÏïÑÏò¨ Îïå usernameÏù¥ Í∞±Ïã†ÎêòÏñ¥Ïïº Ìï©ÎãàÎã§.
        if (intent.hasExtra("username")) {
            loggedInUsername = intent.getStringExtra("username");
        }

        if ("SELECT_DESTINATION".equals(intent.getStringExtra("PURPOSE"))) {
            isSelectionMode = true;
            Toast.makeText(this, "Î™©Ï†ÅÏßÄÎ°ú ÏÑ§Ï†ïÌï† Ïû•ÏÜåÎ•º Í≤ÄÏÉâ ÌõÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.", Toast.LENGTH_LONG).show();
        }

        if (intent.hasExtra("groupId")) {
            currentGroupId = intent.getLongExtra("groupId", -1L);

            // üéØ Î°úÍ∑∏ Ï∂îÍ∞Ä: Ïù∏ÌÖêÌä∏ ÏàòÏã† Î∞è GroupId ÌôïÏù∏
            Log.d(TAG, "handleIntent: Ïù∏ÌÖêÌä∏ ÏàòÏã†Îê®. GroupId=" + currentGroupId + ", Username=" + loggedInUsername);

            if (currentGroupId != -1L) {
                Toast.makeText(this, "Í∑∏Î£π ID: " + currentGroupId + " ÏúÑÏπò Í≥µÏú†Î•º ÏãúÏûëÌï©ÎãàÎã§.", Toast.LENGTH_SHORT).show();
                if (loggedInUserId != -1L) {
                    startLocationSharing();
                } else {
                    // ID Ï°∞ÌöåÎäî onCreateÏóêÏÑú Ïù¥ÎØ∏ ÏãúÏûëÌñàÍ±∞ÎÇò, Ïó¨Í∏∞ÏÑú Îã§Ïãú ÏãúÏûëÌïòÏó¨
                    // ÏÑ±Í≥µ Ïãú startLocationSharing()ÏùÑ Ìò∏Ï∂úÌïòÎèÑÎ°ù ÎßåÎì≠ÎãàÎã§.
                    fetchLoggedInUserId();
                }
            } else {
                Log.w(TAG, "handleIntent: Ïú†Ìö®ÌïòÏßÄ ÏïäÏùÄ Í∑∏Î£π ID(-1L)Î•º Î∞õÏïòÏäµÎãàÎã§. ÏúÑÏπò Í≥µÏú†Î•º ÏãúÏûëÌïòÏßÄ ÏïäÏäµÎãàÎã§.");
            }
        }
    }

    private void reapplyRulesAndRefreshMarkers() {
        // Î°úÍ∑∏Î•º ÌÜµÌï¥ Í∑úÏπô Î≥ÄÍ≤ΩÏúºÎ°ú Ïù∏Ìïú ÎßàÏª§ Í∞±Ïã†Ïù¥ ÏãúÏûëÎê®ÏùÑ ÌôïÏù∏Ìï©ÎãàÎã§.
        Log.d(TAG, "reapplyRulesAndRefreshMarkers: Í∑úÏπô Î≥ÄÍ≤ΩÏúºÎ°ú ÎßàÏª§ Ï¶âÏãú Í∞±Ïã† ÏãúÏûë.");

        // currentMemberLocationsÏóê Ï†ÄÏû•Îêú ÏµúÏã† ÏúÑÏπò Îç∞Ïù¥ÌÑ∞Î•º ÏÇ¨Ïö©ÌïòÏó¨
        // updateMemberMarkersÎ•º Ìò∏Ï∂úÌï©ÎãàÎã§. updateMemberMarkers ÎÇ¥Î∂ÄÏóêÏÑú
        // ÏÉàÎ°ú Î°úÎìúÎêú incomingSharingRulesÏóê Îî∞Îùº ÎßàÏª§ ÌïÑÌÑ∞ÎßÅ Î∞è Ï†úÍ±∞Í∞Ä ÏùºÏñ¥ÎÇ©ÎãàÎã§.
        updateMemberMarkers(currentMemberLocations);
    }

    private void fetchLoggedInUserId() {
        UserApiService apiService = ApiClient.getUserApiService(this);

        // ‚≠êÔ∏è [ÏàòÏ†ï]: UserApiServiceÏùò Ï†ïÏùòÏù∏ Call<Map<String, Long>>ÏôÄ ÏùºÏπòÏãúÌÇ¥
        Call<Map<String, Long>> call = apiService.getUserIdByUsername(loggedInUsername);

        // ‚≠êÔ∏è [ÏàòÏ†ï]: Callback ÌÉÄÏûÖÎèÑ Map<String, Long>ÏúºÎ°ú ÏùºÏπòÏãúÌÇ¥
        call.enqueue(new Callback<Map<String, Long>>() {
            @Override
            public void onResponse(@NonNull Call<Map<String, Long>> call, @NonNull Response<Map<String, Long>> response) {
                if (response.isSuccessful() && response.body() != null) {
                    // ÌÇ§Îäî "userId"Î°ú, Í∞íÏùÄ Long ÌÉÄÏûÖÏúºÎ°ú Í∞ÄÏ†∏Ïò¥
                    Long userId = response.body().get("userId");

                    if (userId != null && userId != -1L) {
                        loggedInUserId = userId;
                        Log.d(TAG, "ÏÇ¨Ïö©Ïûê ID ÌöçÎìù ÏÑ±Í≥µ: " + loggedInUserId);
                        return;
                    }
                    reapplyRulesAndRefreshMarkers();
                }
                Log.e(TAG, "‚ùå ÏÇ¨Ïö©Ïûê ID ÌöçÎìù Ïã§Ìå®. ÏùëÎãµ ÏΩîÎìú: " + response.code());
                finish();
            }

            @Override
            public void onFailure(@NonNull Call<Map<String, Long>> call, @NonNull Throwable t) {
                Log.e(TAG, "ÏÇ¨Ïö©Ïûê ID ÎÑ§Ìä∏ÏõåÌÅ¨ Ïò§Î•ò", t);
                finish();
            }
        });
    }

    private void startLocationSharing() {
        locationUpdateHandler.removeCallbacksAndMessages(null);

        if (loggedInUserId != -1L) {
            fetchIncomingSharingRules();
        } else {
            Log.w(TAG, "startLocationSharing: UserID Î°úÎìú ÎåÄÍ∏∞ Ï§ë. Í∑úÏπô Î°úÎî© ÏÉùÎûµ.");
        }

        Log.d(TAG, "startLocationSharing: ÏúÑÏπò Í≥µÏú† ÌîÑÎ°úÏÑ∏Ïä§ ÏãúÏûë. ÏóÖÎç∞Ïù¥Ìä∏ Ï£ºÍ∏∞=" + LOCATION_UPDATE_INTERVAL + "ms");

        // ... (locationUpdateRunnable Î°úÏßÅÏùÄ ÎèôÏùº)
        locationUpdateHandler.post(locationUpdateRunnable);
        startFirebaseLocationListener();

        // üéØ Î°úÍ∑∏ Ï∂îÍ∞Ä: ÏúÑÏπò Í≥µÏú† ÏãúÏûë
        Log.d(TAG, "startLocationSharing: ÏúÑÏπò Í≥µÏú† ÌîÑÎ°úÏÑ∏Ïä§ ÏãúÏûë. ÏóÖÎç∞Ïù¥Ìä∏ Ï£ºÍ∏∞=" + LOCATION_UPDATE_INTERVAL + "ms");

        locationUpdateRunnable = () -> {
            if (locationSource != null && animationHandler == null) {
                Location lastKnownLocation = locationSource.getLastLocation();
                if (lastKnownLocation != null) {
                    // üéØ Î°úÍ∑∏ Ï∂îÍ∞Ä: ÏúÑÏπò Ï†ïÎ≥¥ ÌöçÎìù Î∞è ÏóÖÎç∞Ïù¥Ìä∏ ÏöîÏ≤≠
                    Log.d(TAG, "Location Update: ÏúÑÏπò ÌöçÎìù ÏÑ±Í≥µ. Latitude=" + lastKnownLocation.getLatitude());
                    updateMyLocation(lastKnownLocation);
                } else {
                    Log.w(TAG, "Location Update: LocationSourceÏóêÏÑú ÎßàÏßÄÎßâ ÏúÑÏπò Ï†ïÎ≥¥Î•º Í∞ÄÏ†∏Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§. GPS Ïã†Ìò∏ ÎåÄÍ∏∞ Ï§ë.");
                }
            } else if (animationHandler != null) {
                Log.d(TAG, "Location Update: Î™®Ïùò(Mock) Ïù¥Îèô Ï§ëÏù¥ÎØÄÎ°ú Ïã§Ï†ú ÏúÑÏπò ÏóÖÎç∞Ïù¥Ìä∏Îäî Í±¥ÎÑàÎúÅÎãàÎã§.");
            }
            locationUpdateHandler.postDelayed(locationUpdateRunnable, LOCATION_UPDATE_INTERVAL);
        };
        locationUpdateHandler.post(locationUpdateRunnable);
        startFirebaseLocationListener();
    }

    private void fetchIncomingSharingRules() {
        if (currentGroupId == -1L || loggedInUserId == -1L) {
            Log.e(TAG, "fetchIncomingSharingRules: Î°úÎìú Ï§ëÎã®. GroupID ÎòêÎäî UserIDÍ∞Ä Ïú†Ìö®ÌïòÏßÄ ÏïäÏäµÎãàÎã§.");
            return;
        }

        GroupApiService apiService = ApiClient.getGroupApiService(this);
        // üí° API Ìò∏Ï∂ú: ÎÇ¥Í∞Ä TargetÏùº Îïå, ÎàÑÍ∞Ä ÎÇòÏóêÍ≤å Í≥µÏú†Î•º ÌóàÏö©ÌñàÎäîÏßÄ Í∑úÏπôÏùÑ Í∞ÄÏ†∏ÏòµÎãàÎã§.
        Call<Map<Long, Boolean>> call = apiService.getSharingRulesForTarget(currentGroupId, loggedInUserId);

        call.enqueue(new Callback<Map<Long, Boolean>>() {
            @Override
            public void onResponse(@NonNull Call<Map<Long, Boolean>> call, @NonNull Response<Map<Long, Boolean>> response) {
                if (response.isSuccessful() && response.body() != null) {
                    incomingSharingRules.clear();
                    incomingSharingRules.putAll(response.body());
                    Log.d(TAG, "‚úÖ Incoming Í∑úÏπô Î°úÎìú ÏÑ±Í≥µ. Î°úÎìúÎêú Í∑úÏπô Ïàò: " + incomingSharingRules.size());
                    Log.d(TAG, "Debugging Rules: Incoming rule for ID 17 (xxx) is " + incomingSharingRules.get(17L));
                } else {
                    Log.e(TAG, "‚ùå Incoming Í∑úÏπô Î°úÎìú Ïã§Ìå®. ÏùëÎãµ ÏΩîÎìú: " + response.code());
                    Toast.makeText(MapsActivity.this, "ÏúÑÏπò Í≥µÏú† Í∑úÏπô Î°úÎìú Ïã§Ìå®. Î™®Îì† Î©§Î≤Ñ ÏúÑÏπò ÌëúÏãú ÏãúÎèÑ.", Toast.LENGTH_SHORT).show();
                }
            }

            @Override
            public void onFailure(@NonNull Call<Map<Long, Boolean>> call, @NonNull Throwable t) {
                Log.e(TAG, "‚ùå Incoming Í∑úÏπô Î°úÎìú ÎÑ§Ìä∏ÏõåÌÅ¨ Ïò§Î•ò", t);
                Toast.makeText(MapsActivity.this, "ÏúÑÏπò Í≥µÏú† Í∑úÏπô Î°úÎìú ÎÑ§Ìä∏ÏõåÌÅ¨ Ïò§Î•ò.", Toast.LENGTH_SHORT).show();
            }
        });
    }


    private void updateMyLocation(Location location) {
        if (currentGroupId == -1L || location == null || loggedInUsername == null || loggedInUserId == -1L) {
            // üéØ Î°úÍ∑∏ Ï∂îÍ∞Ä: ÏúÑÏπò ÏóÖÎç∞Ïù¥Ìä∏ Ï§ëÎã® ÏÇ¨Ïú†
            Log.e(TAG, "updateMyLocation: ÏúÑÏπò ÏóÖÎç∞Ïù¥Ìä∏ Ï§ëÎã®. GroupID=" + currentGroupId + ", Username=" + loggedInUsername + " (Ïú†Ìö®ÌïòÏßÄ ÏïäÏùå)");
            return;
        }

        double latitude = location.getLatitude();
        double longitude = location.getLongitude();
        String firebasePath = String.valueOf(currentGroupId) + "/" + loggedInUsername;

        if (Double.isFinite(latitude) && Double.isFinite(longitude)) {
            HashMap<String, Object> locationData = new HashMap<>();
            locationData.put("latitude", latitude);
            locationData.put("longitude", longitude);
            locationData.put("timestamp", System.currentTimeMillis());
            locationData.put("userId", loggedInUserId);

            // üéØ Î°úÍ∑∏ Ï∂îÍ∞Ä: FirebaseÏóê Ïì∞Í∏∞ ÏãúÏûë
            Log.d(TAG, "updateMyLocation: Firebase Ïì∞Í∏∞ ÏãúÎèÑ. Path=" + firebasePath + ", Lat=" + latitude);

        }
    }

    private void startFirebaseLocationListener() {
        if (currentGroupId == -1L || naverMap == null) {
            Log.e(TAG, "startFirebaseLocationListener: Î¶¨Ïä§ÎÑà ÏãúÏûë Ï§ëÎã®. GroupIDÍ∞Ä Ïú†Ìö®ÌïòÏßÄ ÏïäÍ±∞ÎÇò MapÏù¥ Ï§ÄÎπÑÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.");
            return;
        }

        DatabaseReference groupPathRef = firebaseDatabase.child(String.valueOf(currentGroupId));
        if (memberLocationListener != null) {
            groupPathRef.removeEventListener(memberLocationListener);
            Log.d(TAG, "startFirebaseLocationListener: Í∏∞Ï°¥ Î¶¨Ïä§ÎÑà Ï†úÍ±∞ ÏôÑÎ£å.");
        }

        // üéØ Î°úÍ∑∏ Ï∂îÍ∞Ä: Î¶¨Ïä§ÎÑà Îì±Î°ù
        Log.d(TAG, "startFirebaseLocationListener: Firebase Í∑∏Î£π ÏúÑÏπò Î¶¨Ïä§ÎÑà Îì±Î°ù ÏãúÏûë. GroupPath=" + groupPathRef.toString());

        memberLocationListener = new ValueEventListener() {
            @Override
            public void onDataChange(@NonNull DataSnapshot snapshot) {
                // üéØ Î°úÍ∑∏ Ï∂îÍ∞Ä: Îç∞Ïù¥ÌÑ∞ Î≥ÄÍ≤Ω ÏàòÏã†
                Log.d(TAG, "onDataChange: Îç∞Ïù¥ÌÑ∞ Î≥ÄÍ≤Ω Í∞êÏßÄ. Ï¥ù Î©§Î≤Ñ ÏúÑÏπò Í∞úÏàò: " + snapshot.getChildrenCount());

                // ‚≠êÔ∏è [ÏàòÏ†ï] Î™®Îì† ÏàòÏã† ÏúÑÏπòÎ•º Ï†ÄÏû•Ìï† ÏûÑÏãú Î™©Î°ù (ÌïÑÌÑ∞ÎßÅÎêòÏßÄ ÏïäÏùå)
                List<LocationResponse> rawLocations = new ArrayList<>();
                // ‚≠êÔ∏è [Î≥ÄÍ≤Ω] Í∑úÏπôÏùÑ ÌÜµÍ≥ºÌïú Îç∞Ïù¥ÌÑ∞Îßå Îã¥Îäî Î™©Î°ù
                List<LocationResponse> filteredLocations = new ArrayList<>();

                for (DataSnapshot memberSnapshot : snapshot.getChildren()) {
                    String username = memberSnapshot.getKey();

                    // 1. ÏûêÍ∏∞ ÏûêÏã†Ïùò ÏúÑÏπòÎäî ÎßàÏª§ ÏóÖÎç∞Ïù¥Ìä∏ Î™©Î°ùÏóêÏÑú Ï†úÏô∏
                    if (username != null && username.equals(loggedInUsername)) continue;

                    LocationResponse locationData = memberSnapshot.getValue(LocationResponse.class);

                    if (locationData != null) {
                        // Firebase Realtime DBÎäî usernameÏùÑ KeyÎ°ú ÏÇ¨Ïö©ÌïòÎØÄÎ°ú, DTOÏóê ÏàòÎèô ÏÑ§Ï†ï
                        locationData.setUserName(username);

                        // Ïú†Ìö®ÏÑ± Í≤ÄÏÇ¨ (latitudeÏôÄ longitudeÎäî ÌïÑÏàò)
                        if (locationData.getLatitude() != null && locationData.getLongitude() != null) {

                            // ‚≠êÔ∏è [Ï∂îÍ∞Ä]: ÌïÑÌÑ∞ÎßÅ Ïó¨Î∂ÄÏôÄ Í¥ÄÍ≥ÑÏóÜÏù¥ ÏùºÎã® Î™®Îì† Ïú†Ìö®Ìïú ÏúÑÏπò Îç∞Ïù¥ÌÑ∞Î•º rawLocationsÏóê Ï∂îÍ∞ÄÌï©ÎãàÎã§.
                            rawLocations.add(locationData);

                            Long sharerId = locationData.getUserId();
                            boolean isAllowed = false;

                            // ‚≠ê [ÎîîÎ≤ÑÍ∑∏ Î∞è ÌïÑÌÑ∞ÎßÅ Î°úÏßÅ ÏãúÏûë]
                            if (sharerId != null && sharerId != -1L) {
                                isAllowed = incomingSharingRules.getOrDefault(sharerId, false);

                                // üí° ÌïµÏã¨ ÎîîÎ≤ÑÍπÖ Î°úÍ∑∏: ÌïÑÌÑ∞ÎßÅ Í≤∞Ï†ï Ïù¥Ïú†Î•º ÌôïÏù∏Ìï©ÎãàÎã§.
                                Log.d(TAG, "DEBUG_FILTER_RULE: Sharer ID " + sharerId + " (" + username + ")" +
                                        " | isAllowed=" + isAllowed +
                                        " | Rule in Map: " + (incomingSharingRules.containsKey(sharerId) ? incomingSharingRules.get(sharerId) : "NOT_IN_MAP(false)") );

                                if (!isAllowed) {
                                    Log.d(TAG, "Filtering: Sharer ID " + sharerId + " (" + username + ")Ïùò ÏúÑÏπòÎäî ÏàòÏã† Í∑úÏπôÏóê Îî∞Îùº ÌëúÏãúÎêòÏßÄ ÏïäÏäµÎãàÎã§. (Ï∞®Îã®)");
                                    continue; // ÎßàÏª§ ÏóÖÎç∞Ïù¥Ìä∏ Í±¥ÎÑàÎõ∞Í∏∞
                                }
                            } else {
                                Log.w(TAG, "Filtering Skip: Sharer IDÍ∞Ä ÏóÜÏñ¥ ÌïÑÌÑ∞ÎßÅÏùÑ Í±¥ÎÑàÎúÄ (" + username + ")");
                                // IDÍ∞Ä ÏóÜÎäî Í≤ΩÏö∞ÏóêÎèÑ ÎßàÏª§Î•º ÌëúÏãúÌïòÏßÄ ÏïäÏúºÎ†§Î©¥ Ïó¨Í∏∞ÏóêÎèÑ continue; Î•º Ï∂îÍ∞ÄÌï¥Ïïº Ìï©ÎãàÎã§.
                            }
                            // ‚≠ê [ÎîîÎ≤ÑÍ∑∏ Î∞è ÌïÑÌÑ∞ÎßÅ Î°úÏßÅ ÎÅù]

                            // ‚≠êÔ∏è [ÏàòÏ†ï]: ÌïÑÌÑ∞ÎßÅ ÌÜµÍ≥º Ïãú filteredLocationsÏóê Ï∂îÍ∞ÄÌï©ÎãàÎã§.
                            filteredLocations.add(locationData);

                            // ‚≠ê Î°úÍ∑∏ ÏàòÏ†ï: userId Ï†ïÎ≥¥Í∞Ä Ìè¨Ìï®ÎêòÏóàÎäîÏßÄ ÌôïÏù∏
                            Log.d(TAG, "onDataChange: ÏàòÏã†Îêú Î©§Î≤Ñ ÏúÑÏπò -> " + username +
                                    " at (" + locationData.getLatitude() + ", " + locationData.getLongitude() + ")" +
                                    " / ID: " + locationData.getUserId());
                        }
                    }
                }

                // ‚≠êÔ∏è [ÌïÑÏàò Ï∂îÍ∞Ä]: rawLocationsÎ•º ÌÅ¥ÎûòÏä§ ÌïÑÎìúÏóê Ï†ÄÏû•Ìï©ÎãàÎã§. (reapplyRulesAndRefreshMarkersÏóêÏÑú ÏÇ¨Ïö©)
                currentMemberLocations = rawLocations;

                // ‚≠êÔ∏è [ÏàòÏ†ï]: ÌïÑÌÑ∞ÎßÅÎêú Î™©Î°ùÏùÑ updateMemberMarkersÏóê Ï†ÑÎã¨Ìï©ÎãàÎã§.
                updateMemberMarkers(filteredLocations);
            }

            @Override
            public void onCancelled(@NonNull DatabaseError error) {
                // üéØ Î°úÍ∑∏ Ï∂îÍ∞Ä: Î¶¨Ïä§ÎÑà Ï∑®ÏÜå Ïò§Î•ò (Î≥¥Ïïà Í∑úÏπô Î¨∏Ï†úÏùº Í∞ÄÎä•ÏÑ± ÎÜíÏùå)
                Log.e(TAG, "onCancelled: Firebase Î¶¨Ïä§ÎÑà Ï∑®ÏÜå Ïò§Î•ò (üö®Î≥¥Ïïà Í∑úÏπô ÌôïÏù∏ ÏöîÎßù)", error.toException());
            }
        };
        groupPathRef.addValueEventListener(memberLocationListener);
    }

    private void updateMemberMarkers(List<LocationResponse> locations) {
        if (naverMap == null) return;

        // üéØ Î°úÍ∑∏ Ï∂îÍ∞Ä: ÎßàÏª§ ÏóÖÎç∞Ïù¥Ìä∏ ÏãúÏûë
        Log.d(TAG, "updateMemberMarkers: ÏßÄÎèÑ ÎßàÏª§ ÏóÖÎç∞Ïù¥Ìä∏ ÏãúÏûë. ÏÉà ÏúÑÏπò Í∞úÏàò: " + locations.size());

        List<String> updatedUsernames = new ArrayList<>();
        for (LocationResponse location : locations) {
            if (!Double.isFinite(location.getLatitude()) || !Double.isFinite(location.getLongitude())) continue;

            String username = location.getUserName();
            Long sharerId = location.getUserId();

            // -----------------------------------------------------------------------------------
            // ‚≠êÔ∏è [ÌïµÏã¨ ÌïÑÌÑ∞ÎßÅ Î°úÏßÅ]
            // -----------------------------------------------------------------------------------
            boolean isAllowed = false;
            if (sharerId != null && sharerId != -1L) {
                // isAllowedÏùò Í∏∞Î≥∏Í∞íÏùÑ 'false'(Ï∞®Îã®)Î°ú ÏÑ§Ï†ïÌï©ÎãàÎã§.
                isAllowed = incomingSharingRules.getOrDefault(sharerId, false);

                if (!isAllowed) {
                    // ‚ùå [ÏàòÏ†ï]: ÎßàÏª§ Ï†úÍ±∞ Î°úÏßÅÏùÑ Ïù¥ ÏúÑÏπòÏóêÏÑú Ï†úÍ±∞Ìï©ÎãàÎã§.
                    // ÏµúÏ¢Ö Ï†ïÎ¶¨ Îã®Í≥ÑÏóêÏÑú Î™®Îì† Ï†úÍ±∞Î•º ÏùºÍ¥Ñ Ï≤òÎ¶¨Ìï©ÎãàÎã§.
                    Log.d(TAG, "Filtering: Sharer ID " + sharerId + " (" + username + ")Ïùò ÏúÑÏπòÎäî ÏàòÏã† Í∑úÏπôÏóê Îî∞Îùº ÌëúÏãúÎêòÏßÄ ÏïäÏäµÎãàÎã§. (Ï∞®Îã®)");
                    continue; // ÎßàÏª§ ÏóÖÎç∞Ïù¥Ìä∏ Í±¥ÎÑàÎõ∞Í∏∞
                }
            } else {
                // sharerIdÍ∞Ä ÏóÜÏúºÎ©¥ ÌïÑÌÑ∞ÎßÅ Î∂àÍ∞Ä (ÏÑúÎ≤Ñ ÏàòÏ†ïÏù¥ ÌïÑÏöîÌï©ÎãàÎã§). ÏûÑÏãúÎ°ú Í≥ÑÏÜç ÌëúÏãúÌï©ÎãàÎã§.
                Log.w(TAG, "Filtering Skip: Sharer IDÍ∞Ä ÏóÜÏúºÎØÄÎ°ú (" + username + ")Ïùò ÏúÑÏπòÎäî Í∑úÏπô ÌôïÏù∏ ÏóÜÏù¥ ÌëúÏãúÎê©ÎãàÎã§. (ÏÑúÎ≤Ñ ÏàòÏ†ïÏù¥ ÏôÑÎ£åÎêòÎ©¥ Ìï¥Í≤∞Îê®)");
            }

            // ÌïÑÌÑ∞ÎßÅ ÌÜµÍ≥º (ÎòêÎäî ÌïÑÌÑ∞ÎßÅ ÏÉùÎûµ)
            updatedUsernames.add(username);
            LatLng memberPosition = new LatLng(location.getLatitude(), location.getLongitude());

            // ÎßàÏª§ Ï∂îÍ∞Ä/ÏóÖÎç∞Ïù¥Ìä∏ Î°úÏßÅ (Í∏∞Ï°¥Í≥º ÎèôÏùº)
            Marker marker = memberMarkers.get(username);
            if (marker == null) {
                marker = new Marker();
                marker.setCaptionText(username);
                memberMarkers.put(username, marker);
                Log.d(TAG, "updateMemberMarkers: ÏÉà Î©§Î≤Ñ ÎßàÏª§ Ï∂îÍ∞Ä -> " + username);
            }
            marker.setPosition(memberPosition);
            marker.setMap(naverMap);
        }

        // -----------------------------------------------------------------------------------
        // ‚≠êÔ∏è [ÏµúÏ¢Ö Ï†ïÎ¶¨ Î°úÏßÅ ÏàòÏ†ï]: ÏßÄÎèÑÏóê ÎÇ®ÏïÑÏûàÎäî ÎßàÏª§Î•º ÌôïÏã§ÌïòÍ≤å Ï†úÍ±∞
        // -----------------------------------------------------------------------------------
        // updatedUsernamesÏóê ÏóÜÎäî Î™®Îì† ÎßàÏª§(Ï∞®Îã®Îêú Î©§Î≤Ñ, ÏúÑÏπòÍ∞Ä ÎÅäÍ∏¥ Î©§Î≤Ñ)Îäî ÏßÄÎèÑÏóêÏÑú Ï†úÍ±∞Ìï¥Ïïº Ìï©ÎãàÎã§.
        Iterator<Map.Entry<String, Marker>> iterator = memberMarkers.entrySet().iterator();
        while (iterator.hasNext()) {
            Map.Entry<String, Marker> entry = iterator.next();
            String username = entry.getKey();

            // updatedUsernamesÏóê Ìè¨Ìï®ÎêòÏßÄ ÏïäÏùÄ ÎßàÏª§Îäî Ï†úÍ±∞ ÎåÄÏÉÅÏûÖÎãàÎã§.
            if (!updatedUsernames.contains(username)) {
                entry.getValue().setMap(null); // ÏßÄÎèÑÏóêÏÑú ÎßàÏª§ Ï†úÍ±∞
                iterator.remove();             // ÎßµÏóêÏÑú Ìï¥Îãπ ÏóîÌä∏Î¶¨ Ï†úÍ±∞
                Log.d(TAG, "updateMemberMarkers: ÏµúÏ¢Ö Ï†ïÎ¶¨ ÎßàÏª§ Ï†úÍ±∞ -> Name: " + username);
            }
        }
    }

    //==============================================================================================
    // 4. Mock Movement & Destination Selection (Î°úÍ∑∏ Ï∂îÍ∞Ä)
    //==============================================================================================

    private void loadWeatherData() {
        LatLng defaultLocation = new LatLng(37.5665, 126.9780);
        updateWeatherWidget(defaultLocation);
    }

    private void startMockMovement() {
        if (animationHandler != null) {
            animationHandler.removeCallbacks(animationRunnable);
        }
        animationHandler = new Handler(Looper.getMainLooper());
        startTime = System.currentTimeMillis();
        startLatLng = myLocationMarker.getPosition();

        Toast.makeText(this, "Mock movement to Busan started.", Toast.LENGTH_LONG).show();
        Log.d(TAG, "startMockMovement: Í∞ÄÏÉÅ Ïù¥Îèô ÏãúÏûë. ÏãúÏûë ÏúÑÏπò: " + startLatLng.latitude);

        animationRunnable = new Runnable() {
            @Override
            public void run() {
                long elapsed = System.currentTimeMillis() - startTime;
                float fraction = Math.min((float) elapsed / totalDuration, 1.0f);

                double lat = startLatLng.latitude + (endLatLng.latitude - startLatLng.latitude) * fraction;
                double lon = startLatLng.longitude + (endLatLng.longitude - startLatLng.longitude) * fraction;
                LatLng currentLatLng = new LatLng(lat, lon);

                myLocationMarker.setPosition(currentLatLng);
                naverMap.moveCamera(CameraUpdate.scrollTo(currentLatLng));

                Location mockLocation = new Location("MockProvider");
                mockLocation.setLatitude(lat);
                mockLocation.setLongitude(lon);
                updateMyLocation(mockLocation); // üéØ Í∞ÄÏÉÅ ÏúÑÏπòÎèÑ FirebaseÏóê ÏóÖÎç∞Ïù¥Ìä∏

                if (fraction < 1.0) {
                    animationHandler.postDelayed(this, updateInterval);
                } else {
                    Toast.makeText(MapsActivity.this, "Arrived in Busan.", Toast.LENGTH_SHORT).show();
                    Log.d(TAG, "startMockMovement: Í∞ÄÏÉÅ Ïù¥Îèô ÏôÑÎ£å.");
                    animationHandler = null;
                }
            }
        };
        animationHandler.post(animationRunnable);
    }

    @Override
    public void onDestinationSelected(SearchResult selectedResult) {
        Toast.makeText(this, selectedResult.getTitle() + " selected as destination.", Toast.LENGTH_LONG).show();
        hideSearchResults();
        if (searchResultMarker != null) searchResultMarker.setMap(null);

        Intent intent = new Intent(this, CreateGroupActivity.class);
        intent.putExtra("destination_result", selectedResult);
        intent.putExtra("username", loggedInUsername);
        startActivity(intent);
    }

    //==============================================================================================
    // 5. UI Features (Menus, Search, Weather - ÏàòÏ†ï ÏóÜÏùå)
    //==============================================================================================

    private void toggleSubMenu() {
        if (isSubMenuOpen) hideSubMenu();
        else showSubMenu();
    }

    private void showSubMenu() {
        isSubMenuOpen = true;
        FloatingActionButton btnMainMenu = findViewById(R.id.btnMainMenu);
        btnMainMenu.setImageResource(R.drawable.ic_close);
        btnMainMenu.setBackgroundTintList(ColorStateList.valueOf(ContextCompat.getColor(this, R.color.red)));

        FloatingActionButton[] targets = {
                findViewById(R.id.btnFriends), findViewById(R.id.btnCreateGroup),
                findViewById(R.id.btnMyGroups), findViewById(R.id.btnMyPage), findViewById(R.id.btnSettings)
        };
        float[] angles = {180f, 135f, 90f, 45f, 0f};
        float radiusPx = dpToPx(SUB_MENU_RADIUS_DP);

        for (int i = 0; i < targets.length; i++) {
            targets[i].setVisibility(View.VISIBLE);
            targets[i].setAlpha(0f);
            double rad = Math.toRadians(angles[i]);
            float tx = (float) (Math.cos(rad) * radiusPx * 1.2); // Adjust distance
            float ty = (float) (Math.sin(rad) * radiusPx * -1.2); // Adjust distance & invert Y
            targets[i].animate().translationX(tx).translationY(ty).alpha(1f).setDuration(300).setStartDelay(i * 40L).start();
        }
    }

    private void hideSubMenu() {
        isSubMenuOpen = false;
        FloatingActionButton btnMainMenu = findViewById(R.id.btnMainMenu);
        btnMainMenu.setImageResource(R.drawable.ic_menu);
        btnMainMenu.setBackgroundTintList(ColorStateList.valueOf(ContextCompat.getColor(this, R.color.colorPrimary)));

        FloatingActionButton[] targets = {
                findViewById(R.id.btnFriends), findViewById(R.id.btnCreateGroup),
                findViewById(R.id.btnMyGroups), findViewById(R.id.btnMyPage), findViewById(R.id.btnSettings)
        };

        for (int i = 0; i < targets.length; i++) {
            int finalI = i;
            targets[i].animate().translationX(0f).translationY(0f).alpha(0f).setDuration(250).setStartDelay((targets.length - 1 - i) * 30L)
                    .withEndAction(() -> targets[finalI].setVisibility(View.GONE)).start();
        }
    }

    private void initializeSubMenu() {
        FloatingActionButton[] targets = {
                findViewById(R.id.btnFriends), findViewById(R.id.btnCreateGroup),
                findViewById(R.id.btnMyGroups), findViewById(R.id.btnMyPage), findViewById(R.id.btnSettings)
        };
        for(FloatingActionButton fab : targets) {
            fab.setVisibility(View.GONE);
            fab.setAlpha(0f);
        }
    }

    private void bindMyPageHeader() {
        TextView tvUsername = findViewById(R.id.tv_username);
        TextView tvEmail = findViewById(R.id.tv_email);
        if (tvUsername != null) tvUsername.setText(loggedInUsername != null ? loggedInUsername : "Guest");
        if (tvEmail != null) tvEmail.setText(getSharedPreferences("user_info", MODE_PRIVATE).getString("email", ""));

        findViewById(R.id.btn_logout).setOnClickListener(v -> {
            new TokenManager(this).deleteToken();
            Intent intent = new Intent(this, LoginActivity.class);
            intent.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK | Intent.FLAG_ACTIVITY_CLEAR_TASK);
            startActivity(intent);
            finish();
        });
    }

    private void performSearch() {
        String query = etSearch.getText().toString().trim();
        if (query.isEmpty()) {
            Toast.makeText(this, "Í≤ÄÏÉâÏñ¥Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.", Toast.LENGTH_SHORT).show();
            return;
        }
        hideKeyboard();
        searchPlacesWithNaverAPI(query);
    }

    private void searchPlacesWithNaverAPI(String query) {
        executor.execute(() -> {
            try {
                String encodedQuery = java.net.URLEncoder.encode(query, "UTF-8");
                URL url = new URL("https://openapi.naver.com/v1/search/local.json?query=" + encodedQuery + "&display=10");
                HttpURLConnection conn = (HttpURLConnection) url.openConnection();
                conn.setRequestMethod("GET");
                conn.setRequestProperty("X-Naver-Client-Id", NAVER_CLIENT_ID);
                conn.setRequestProperty("X-Naver-Client-Secret", NAVER_CLIENT_SECRET);

                if (conn.getResponseCode() == 200) {
                    BufferedReader reader = new BufferedReader(new InputStreamReader(conn.getInputStream()));
                    StringBuilder response = new StringBuilder();
                    String line;
                    while ((line = reader.readLine()) != null) response.append(line);

                    List<SearchResult> results = parseNaverSearchResults(new JSONObject(response.toString()));
                    handler.post(() -> {
                        if (results.isEmpty()) Toast.makeText(this, "Í≤ÄÏÉâ Í≤∞Í≥ºÍ∞Ä ÏóÜÏäµÎãàÎã§.", Toast.LENGTH_SHORT).show();
                        else showSearchResults(results);
                    });
                } else {
                    handler.post(() -> Toast.makeText(this, "API Ïò§Î•ò Î∞úÏÉù", Toast.LENGTH_SHORT).show());
                }
            } catch (Exception e) {
                Log.e("SearchAPI", "Search failed", e);
                handler.post(() -> Toast.makeText(this, "Í≤ÄÏÉâ Ï§ë Ïò§Î•ò Î∞úÏÉù", Toast.LENGTH_SHORT).show());
            }
        });
    }

    private List<SearchResult> parseNaverSearchResults(JSONObject json) throws Exception {
        List<SearchResult> results = new ArrayList<>();
        JSONArray items = json.getJSONArray("items");
        for (int i = 0; i < items.length(); i++) {
            JSONObject item = items.getJSONObject(i);
            String title = item.getString("title").replaceAll("<[^>]*>", "");
            String address = item.optString("roadAddress", item.optString("address", ""));
            String category = item.optString("category", "Ï†ïÎ≥¥ ÏóÜÏùå");

            // Correct coordinate parsing from Code 1
            double longitude = item.getDouble("mapx") / 1e7;
            double latitude = item.getDouble("mapy") / 1e7;

            results.add(new SearchResult(title, address, category, latitude, longitude, "", ""));
        }
        return results;
    }

    private void moveToSearchResult(SearchResult result) {
        if (naverMap != null) {
            LatLng location = new LatLng(result.getLatitude(), result.getLongitude());
            naverMap.moveCamera(CameraUpdate.scrollAndZoomTo(location, 16).animate(CameraAnimation.Easing));

            if (searchResultMarker != null) searchResultMarker.setMap(null);
            searchResultMarker = new Marker(location);
            searchResultMarker.setCaptionText(result.getTitle());
            searchResultMarker.setMap(naverMap);

            SearchResultDetailFragment.newInstance(result).show(getSupportFragmentManager(), "SearchResultDetail");
        }
    }

    private void showSearchResults(List<SearchResult> results) {
        searchResultAdapter.updateResults(results);
        rvSearchResults.setVisibility(View.VISIBLE);
    }

    private void hideSearchResults() {
        rvSearchResults.setVisibility(View.GONE);
    }

    private void showWeatherBottomSheet() {
        Location location = locationSource.getLastLocation();
        double lat = (location != null) ? location.getLatitude() : 37.5665;
        double lon = (location != null) ? location.getLongitude() : 126.9780;
        WeatherBottomSheetFragment.newInstance(lat, lon).show(getSupportFragmentManager(), "WeatherBottomSheet");
    }

    private void updateWeatherWidget(LatLng location) {
        executor.execute(() -> {
            try {
                URL url = new URL(String.format(Locale.US,
                        "https://api.openweathermap.org/data/2.5/weather?lat=%f&lon=%f&appid=%s&units=metric&lang=kr",
                        location.latitude, location.longitude, OPENWEATHERMAP_API_KEY));
                HttpURLConnection conn = (HttpURLConnection) url.openConnection();

                if (conn.getResponseCode() == 200) {
                    BufferedReader reader = new BufferedReader(new InputStreamReader(conn.getInputStream()));
                    StringBuilder response = new StringBuilder();
                    String line;
                    while((line = reader.readLine()) != null) response.append(line);

                    JSONObject json = new JSONObject(response.toString());
                    double temp = json.getJSONObject("main").getDouble("temp");
                    String weatherMain = json.getJSONArray("weather").getJSONObject(0).getString("main");

                    handler.post(() -> {
                        tvTemperature.setText(String.format(Locale.getDefault(), "%.0f¬∞", temp));
                        ivWeatherIcon.setImageResource(getWeatherIconResource(weatherMain));
                    });
                }
            } catch (Exception e) {
                Log.e("WeatherAPI", "Failed to load weather", e);
            }
        });
    }

    private int getWeatherIconResource(String weatherMain) {
        switch (weatherMain.toLowerCase()) {
            case "clear": return R.drawable.ic_weather_clear;
            case "clouds": return R.drawable.ic_weather_cloudy;
            case "rain": case "drizzle": return R.drawable.ic_weather_rainy;
            case "snow": return R.drawable.ic_weather_snow;
            default: return R.drawable.ic_weather_clear;
        }
    }


    //==============================================================================================
    // 6. Permissions & Utilities (ÏàòÏ†ï ÏóÜÏùå)
    //==============================================================================================

    private void checkLocationPermission() {
        if (ContextCompat.checkSelfPermission(this, Manifest.permission.ACCESS_FINE_LOCATION) != PackageManager.PERMISSION_GRANTED) {
            ActivityCompat.requestPermissions(this, new String[]{Manifest.permission.ACCESS_FINE_LOCATION}, LOCATION_PERMISSION_REQUEST_CODE);
        }
    }

    @Override
    public void onRequestPermissionsResult(int requestCode, @NonNull String[] permissions, @NonNull int[] grantResults) {
        super.onRequestPermissionsResult(requestCode, permissions, grantResults);
        if (locationSource.onRequestPermissionsResult(requestCode, permissions, grantResults)) {
            if (naverMap != null) naverMap.setLocationTrackingMode(LocationTrackingMode.Follow);
        }
    }

    private void moveToCurrentLocation() {
        if (naverMap != null && locationSource.getLastLocation() != null) {
            Location loc = locationSource.getLastLocation();
            naverMap.moveCamera(CameraUpdate.scrollAndZoomTo(new LatLng(loc.getLatitude(), loc.getLongitude()), 16)
                    .animate(CameraAnimation.Easing));
        }
    }

    private void showMapTypeMenu(View anchor) {
        PopupMenu popup = new PopupMenu(this, anchor);
        popup.getMenuInflater().inflate(R.menu.map_type_menu, popup.getMenu());
        popup.setOnMenuItemClickListener(item -> {
            int id = item.getItemId();
            if (id == R.id.map_type_normal) naverMap.setMapType(NaverMap.MapType.Basic);
            else if (id == R.id.map_type_satellite) naverMap.setMapType(NaverMap.MapType.Satellite);
            else if (id == R.id.map_type_terrain) naverMap.setMapType(NaverMap.MapType.Terrain);
            return true;
        });
        popup.show();
    }

    private void startRulesVersionListener() {
        if (currentGroupId == -1L) return;

        // Í∑úÏπô Î≤ÑÏ†Ñ Ï∞∏Ï°∞ ÏÑ§Ï†ï: group_rules_version/{groupId}
        rulesVersionRef = FirebaseDatabase.getInstance()
                .getReference("group_rules_version")
                .child(String.valueOf(currentGroupId));

        // Í∏∞Ï°¥ Î¶¨Ïä§ÎÑà Ï†úÍ±∞ (Ï§ëÎ≥µ Î∞©ÏßÄ)
        if (rulesVersionListener != null) {
            rulesVersionRef.removeEventListener(rulesVersionListener);
        }

        rulesVersionListener = new ValueEventListener() {
            @Override
            public void onDataChange(@NonNull DataSnapshot snapshot) {
                // Í∑úÏπô Î≤ÑÏ†ÑÏù¥ Î≥ÄÍ≤ΩÎêòÏóàÏùÑ Îïå (Îã§Î•∏ Î©§Î≤ÑÍ∞Ä ÏÑ§Ï†ïÏùÑ Ï†ÄÏû• Ïãú)
                Log.d(TAG, "Rules Version Change Detected for Group " + currentGroupId + ". Reloading incoming sharing rules.");
                // Î™®Îì† ÎîîÎ∞îÏù¥Ïä§ÏóêÏÑú Ïù¥ ÏΩîÎìúÍ∞Ä Ïã§ÌñâÎêòÎ©∞ Í∑úÏπôÏùÑ ÏÑúÎ≤ÑÏóêÏÑú Îã§Ïãú Í∞ÄÏ†∏ÏòµÎãàÎã§.
                fetchIncomingSharingRules();
            }

            @Override
            public void onCancelled(@NonNull DatabaseError error) {
                Log.e(TAG, "Rules Version Listener Cancelled", error.toException());
            }
        };
        // Î¶¨Ïä§ÎÑà Îì±Î°ù
        rulesVersionRef.addValueEventListener(rulesVersionListener);
        Log.d(TAG, "startRulesVersionListener: Í∑úÏπô Î≤ÑÏ†Ñ Î¶¨Ïä§ÎÑà Îì±Î°ù ÏôÑÎ£å. Group ID: " + currentGroupId);
    }

    private float dpToPx(float dp) {
        return dp * getResources().getDisplayMetrics().density;
    }

    private void hideKeyboard() {
        InputMethodManager imm = (InputMethodManager) getSystemService(Context.INPUT_METHOD_SERVICE);
        View view = getCurrentFocus();
        if (view != null) imm.hideSoftInputFromWindow(view.getWindowToken(), 0);
    }

    private void applyMapTypeSetting() {
        SharedPreferences prefs = getSharedPreferences("app_settings", MODE_PRIVATE);
        boolean isSatellite = prefs.getBoolean("satellite_mode", false);
        if (naverMap != null) naverMap.setMapType(isSatellite ? NaverMap.MapType.Satellite : NaverMap.MapType.Basic);
    }

    //==============================================================================================
    // 7. Activity Lifecycle Callbacks (Î°úÍ∑∏ Ï∂îÍ∞Ä)
    //==============================================================================================

    @Override
    protected void onStart() { super.onStart(); mapView.onStart(); }

    @Override
    protected void onResume() {
        super.onResume();
        mapView.onResume();
        applyMapTypeSetting();

        if (currentGroupId != -1L) {
            Log.d(TAG, "onResume: Ïú†Ìö®Ìïú Í∑∏Î£π ID(" + currentGroupId + ")Í∞Ä ÏûàÏñ¥ ÏúÑÏπò Í≥µÏú† Ïû¨ÏãúÏûë.");

            if (rulesNeedReload) {
                Log.d(TAG, "onResume: Í≥µÏú† ÏÑ§Ï†ï Î≥ÄÍ≤Ω Í∞êÏßÄ. Incoming Í∑úÏπô Í∞ïÏ†ú Ïû¨Î°úÎìú ÏãúÏûë.");
                fetchIncomingSharingRules();
                rulesNeedReload = false;
            }

            startLocationSharing();
            // ‚≠ê [Î≥ÄÍ≤Ω] onResume Ïãú Í∑úÏπô Î≤ÑÏ†Ñ Î¶¨Ïä§ÎÑà ÏãúÏûë (Ïã§ÏãúÍ∞Ñ ÎèôÍ∏∞Ìôî)
            startRulesVersionListener();

        } else {
            Log.d(TAG, "onResume: Í∑∏Î£π IDÍ∞Ä ÏóÜÏñ¥ ÏúÑÏπò Í≥µÏú†Î•º ÏãúÏûëÌïòÏßÄ ÏïäÏùå.");
        }
    }

    @Override
    protected void onPause() {
        super.onPause();
        mapView.onPause();

        locationUpdateHandler.removeCallbacksAndMessages(null);
        Log.d(TAG, "onPause: Ï£ºÍ∏∞Ï†ÅÏù∏ ÏúÑÏπò ÏóÖÎç∞Ïù¥Ìä∏ (Handler) Ï§ëÎã®.");

        if (animationHandler != null) {
            animationHandler.removeCallbacks(animationRunnable);
            animationHandler = null;
        }

        if (currentGroupId != -1L) {
            if (memberLocationListener != null) {
                firebaseDatabase.child(String.valueOf(currentGroupId)).removeEventListener(memberLocationListener);
                Log.d(TAG, "onPause: Firebase ÏúÑÏπò Î¶¨Ïä§ÎÑà Ï†úÍ±∞ ÏôÑÎ£å.");
            }
            // ‚≠ê [Î≥ÄÍ≤Ω] Í∑úÏπô Î≤ÑÏ†Ñ Î¶¨Ïä§ÎÑà Ï†úÍ±∞
            if (rulesVersionRef != null && rulesVersionListener != null) {
                rulesVersionRef.removeEventListener(rulesVersionListener);
                Log.d(TAG, "onPause: Firebase Í∑úÏπô Î≤ÑÏ†Ñ Î¶¨Ïä§ÎÑà Ï†úÍ±∞ ÏôÑÎ£å.");
            }
        }
    }

    @Override
    protected void onStop() { super.onStop(); mapView.onStop(); }

    @Override
    protected void onDestroy() {
        super.onDestroy();
        mapView.onDestroy();

        // ‚≠ê [Ï∂îÍ∞Ä] Í∑úÏπô Î≤ÑÏ†Ñ Î¶¨Ïä§ÎÑà Ìï¥Ï†ú (Ï§ëÎ≥µ Ìò∏Ï∂ú Î∞©ÏßÄ)
        if (rulesVersionRef != null && rulesVersionListener != null) {
            rulesVersionRef.removeEventListener(rulesVersionListener);
            Log.d(TAG, "onDestroy: Firebase Í∑úÏπô Î≤ÑÏ†Ñ Î¶¨Ïä§ÎÑà Ï†úÍ±∞ ÏôÑÎ£å.");
        }
    }

    @Override
    public void onLowMemory() { super.onLowMemory(); mapView.onLowMemory(); }

}
